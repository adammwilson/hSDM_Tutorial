---
title: "Overview of hSDM"
author: "Adam M. Wilson"
date: "January 6, 2015"
output:
  knitrBootstrap::bootstrap_document:
    highlight: Magula
    highlight.chooser: no
    theme: cerulean
    theme.chooser: no
  md_document:
    variant: markdown_github
---

```{r, echo=FALSE, warning=FALSE}
library(knitr)
library(rmarkdown)

opts_chunk$set(cache=TRUE,
               root.dir="/Users/adamw/repos/hSDM_Tutorial",
               warning=FALSE,
               message=F,
               fig.width=15,fig.height=15)

# rmarkdown::render("R/hSDM_DataPrep.Rmd", "all")

```
# Data Preparation for hSDM tutorial


## Load libraries
```{r loadLibraries,message=FALSE,warning=FALSE}
library(hSDM)
library(ggplot2)
library(rasterVis)
library(raster)
library(maptools)
library(dplyr)
```


__________

## Example Species: *Montane Woodcreeper* (_Lepidocolaptes lacrymiger_)

![Lepidocolaptes_lacrymiger Photo](../assets/Lepidocolaptes_lacrymiger.jpg)
<br><span style="color:grey; font-size:1em;">Figure from [hbw.com](http://www.hbw.com/species/montane-woodcreeper-lepidocolaptes-lacrymiger) </span>

> This species has a large range, occurring from the coastal cordillera of Venezuela along the Andes south to south-east Peru and central Bolivia. [birdlife.org](http://www.birdlife.org/datazone/speciesfactsheet.php?id=31946)

```{r}
sp="Lepidocolaptes_lacrymiger"

## set path to data folder
datadir=paste0("../data/",sp,"/")

```

## Query eBird data contained in MOL

* Find all observations of our species
* Find all unique observation locations for any species limited to bounding box of expert range
* Filter to where observer indicated recording all observed species (`all_species_reported='t'`)
* Filter to lists that do not correspond to an observation of our species

> The best method for selecting data to use for _non-detections_ is very case and dataset specific.

Metadata for eBird^[M. Arthur Munson, Kevin Webb, Daniel Sheldon, Daniel Fink, Wesley M. Hochachka, Marshall Iliff, Mirek Riedewald, Daria Sorokina, Brian Sullivan, Christopher Wood, and Steve Kelling. The eBird Reference Dataset, Version 5.0. Cornell Lab of Ornithology and National Audubon Society, Ithaca, NY, January 2013.] is [available here](http://ebirddata.ornith.cornell.edu/downloads/erd/ebird_all_species/erd_western_hemisphere_data_grouped_by_year_v5.0.tar.gz)

Below is an R function that queries the eBird data and summarized as bulleted above.  This database is not currently publically accessible, so we're providing the summarized data below.  

```{r, eval=FALSE}

# install_github("pingles/redshift-r")
getebird=function(con, sptaxon, region){
  print(paste("Extracting data, this can take a few minutes..."))
    dbGetQuery(conn,paste(   
        "WITH ebird_subset as (SELECT 
            all_species_reported,
            taxonomic_order,
            latitude,
            longitude,
            observation_date,
            sampling_event_identifier,
            group_identifier,
            effort_distance_km,
            effort_area_ha,
            duration_minutes
          FROM ebird
          WHERE latitude BETWEEN ",paste(bbox(region)["y",],collapse=" AND "),"
          AND longitude BETWEEN ",paste(bbox(region)["x",],collapse=" AND "),")
        presence as (SELECT DISTINCT 
            latitude,
            longitude,
            observation_date,
            sampling_event_identifier,
            group_identifier,
            effort_distance_km,
            effort_area_ha,
            duration_minutes,
            1 AS presence
          FROM ebird_subset
          WHERE floor(taxonomic_order) IN (",paste(sptaxon,collapse=","),"))
          absence as (SELECT DISTINCT
            latitude,
            longitude,
            observation_date,
            sampling_event_identifier,
            group_identifier,
            effort_distance_km,
            effort_area_ha,
            duration_minutes,
            0 AS presence
          FROM ebird_subset
          WHERE all_species_reported='t'
          AND sampling_event_identifier NOT IN (SELECT
            sampling_event_identifier FROM presence))
          SELECT 
            latitude,
            longitude,
            observation_date,
            presence,
            effort_distance_km,
            duration_minutes,
            effort_area_ha 
          FROM presence
         UNION
          SELECT
              latitude,
              longitude,
              observation_date,
              presence,
              effort_distance_km,
              duration_minutes,
              effort_area_ha 
          FROM absence"))
    }
```


Use the `getebird()` function to query the database and return the summarized data frame.
```{r, eval=FALSE}
## get species data
require(redshift)
rs_url="jdbc:postgresql://***redshift.amazonaws.com:5439/mol?tcpKeepAlive=true"

conn <- redshift.connect(rs_url)

spd_all=getebird(
  con=conn,
  sptaxon=sptaxon,
  nulltaxon=NULL,
  region=reg
  )

```


### Annotate with Environmental Data
```{r}
fspData="Lepidocolaptes_lacrymiger_points.csv"

spd_all=read.csv(fspData)

coordinates(spd_all)=c("longitude","latitude")
projection(spd_all)="+proj=longlat +datum=WGS84 +ellps=WGS84"
spd_all@data[,c("lon","lat")]=coordinates(spd_all)  


fenvdata="data/Lepidocolaptes_lacrymiger.tif"

env=stack(paste0(sp,"_env.tif"))
names(env)=c("PPTJAN","PPTJUL","PPTSEAS","MAT","ALT","CLDJAN","CLDJUL","CLDSEAS")
```
### Scale environmental data
Scaling covariate data^[subtract the mean and divide by the standard deviation] results in standardized parameter values and also can speed up modeling convergence.  It's possible to _unscale_ the results later if desired.

```{r scaleEnv,eval=FALSE}
## Create a 'scaled' version for modeling
senv=raster::scale(env)*100
names(senv)=c("PPTJAN","PPTJUL","PPTSEAS","MAT","ALT","CLDJAN","CLDJUL","CLDSEAS")

writeRaster(senv,paste0(sp,"_env_scaled.tif"),
            datatype="INT2S",overwrite=T,
            options=c("COMPRESS=LZW", "PREDICTOR=2"))

## create smaller version for workshop
system("gdal_translate Lepidocolaptes_lacrymiger_env_scaled.tif Lepidocolaptes_lacrymiger_env_scaled_small.tif -co 'COMPRESS=LZW' -co 'PREDICTOR=2' -projwin -78 8 -72 3")

```

```{r}
#### Extract data for points
gain(senv)=.01
spd_env=extract(senv,spd_all,cellnumbers=T)
spd_cellcoords=coordinates(senv)[spd_env[,"cells"],]
colnames(spd_cellcoords)=c("cell_lon","cell_lat")
head(spd_env)

spd_all2=cbind.data.frame(spd_all,spd_env,spd_cellcoords)

write.csv(spd_all2[,-1],file=paste0(sp,"_points_env.csv"))
```